name: Build OneCloud ImmortalWrt

on:
  schedule:
    - cron: '0 16 * * *'  # 每天北京时间 00:00 自动构建（UTC+8）
  workflow_dispatch:
    inputs:
      kernel_version:
        description: '选择内核版本'
        required: true
        default: '6.6'
        type: choice
        options:
          - 6.6
          - 6.10
          - 6.12

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      TZ: Asia/Shanghai
      OPENWRT_DIR: openwrt

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install base deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gawk flex bison libssl-dev libncurses5-dev zlib1g-dev \
            git gettext unzip wget curl rsync swig file device-tree-compiler \
            python3 subversion qemu-utils upx-ucl xz-utils zstd \
            dosfstools sfdisk

      - name: Clone ImmortalWrt 24.10
        run: |
          git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git "${OPENWRT_DIR}"

      - name: Apply .config and diy.sh (if present)
        run: |
          if [ -f ".config" ]; then cp -f .config "${OPENWRT_DIR}/.config"; fi
          if [ -f "diy.sh" ]; then cp -f diy.sh "${OPENWRT_DIR}/diy.sh" && chmod +x "${OPENWRT_DIR}/diy.sh"; fi
          cd "${OPENWRT_DIR}"
          [ -x "./diy.sh" ] && ./diy.sh || true

      - name: Feeds
        run: |
          cd "${OPENWRT_DIR}"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure
        run: |
          cd "${OPENWRT_DIR}"
          make defconfig

      - name: Download sources
        run: |
          cd "${OPENWRT_DIR}"
          make download -j"$(nproc)"

      - name: Build
        run: |
          cd "${OPENWRT_DIR}"
          make -j"$(nproc)" || make -j1 V=s

      - name: Make USB and Direct-Flash images
        run: |
          set -euo pipefail
          TARGET_DIR="$(ls -d ${OPENWRT_DIR}/bin/targets/*/*)"
          echo "TARGET_DIR=${TARGET_DIR}"

          INITRAMFS_IMG="$(ls ${TARGET_DIR}/*initramfs* 2>/dev/null | head -n1 || true)"
          SYSUP_IMG="$(ls ${TARGET_DIR}/*sysupgrade*.tar 2>/dev/null | head -n1 || true)"
          ROOTFS_EXT4_IMG="$(ls ${TARGET_DIR}/*-rootfs-ext4.img* 2>/dev/null | head -n1 || true)"

          echo "INITRAMFS: ${INITRAMFS_IMG}"
          echo "SYSUP:     ${SYSUP_IMG}"
          echo "ROOTFS:    ${ROOTFS_EXT4_IMG}"

          if [ -z "${SYSUP_IMG}" ]; then
            echo "Error: 未找到 sysupgrade 镜像，无法生成刷机包"
            exit 1
          fi

          mk_fat32_img() {
            local img="$1"; local size_mb="$2"; shift 2
            local files=( "$@" )

            rm -f "${img}"
            dd if=/dev/zero of="${img}" bs=1M count="${size_mb}" status=none
            printf ',,c,*\n' | sfdisk -q "${img}"

            START_SECTOR=$(sfdisk -d "${img}" | awk '/Id=0x0c/ {for(i=1;i<=NF;i++) if($i ~ /start=/){gsub(/start=|,/, "", $i); print $i}}')
            [ -z "${START_SECTOR}" ] && START_SECTOR=2048
            OFFSET=$(( START_SECTOR * 512 ))
            LOOP=$(sudo losetup -f --show -o "${OFFSET}" "${img}")
            sudo mkfs.vfat -F 32 -n ONECLOUD "${LOOP}" >/dev/null
            sync

            TMPDIR="$(mktemp -d)"
            sudo mount -o uid=$(id -u),gid=$(id -g) "${LOOP}" "${TMPDIR}"
            for f in "${files[@]}"; do
              [ -f "$f" ] && cp -f "$f" "${TMPDIR}/"
            done

            if echo "${img}" | grep -q 'usb-installer'; then
              cat > "${TMPDIR}/README.txt" << 'RUSB'
OneCloud USB 安装器（非可引导整盘）
包含：sysupgrade*.tar（必有）、initramfs*（若存在）、flash-emmc.sh（一键刷写）
用法：进入 initramfs 后挂载 U 盘执行 /mnt/usb/flash-emmc.sh 完成 eMMC 安装
RUSB
              cat > "${TMPDIR}/flash-emmc.sh" << 'RSH'
#!/bin/sh
set -e
IMG="$(ls "$(dirname "$0")"/*sysupgrade*.tar 2>/dev/null | head -n1)"
[ -z "$IMG" ] && { echo "未找到 sysupgrade 镜像"; exit 1; }
echo "[*] 开始刷写：$IMG"
sync
sysupgrade -n "$IMG"
RSH
              chmod +x "${TMPDIR}/flash-emmc.sh"
            else
              cat > "${TMPDIR}/README.txt" << 'REMMC'
OneCloud 线刷包（非可引导整盘）
包含：sysupgrade*.tar（推荐方式）、rootfs-ext4.img*（可选，高级手工用途）
说明：不含 bootloader/FIP，不保证写盘即引导；普通用户请使用 sysupgrade 搭配安装器
REMMC
              ( cd "${TMPDIR}" && sha256sum * > SHA256SUMS.txt )
            fi

            sync
            sudo umount "${TMPDIR}"
            rmdir "${TMPDIR}"
            sudo losetup -d "${LOOP}"
          }

          USB_IMG="onecloud-usb-installer-${GITHUB_RUN_NUMBER}.img"
          USB_FILES=( "${SYSUP_IMG}" )
          [ -n "${INITRAMFS_IMG}" ] && USB_FILES+=( "${INITRAMFS_IMG}" )
          mk_fat32_img "${USB_IMG}" 256 "${USB_FILES[@]}"

          EMMC_IMG="onecloud-direct-flash-${GITHUB_RUN_NUMBER}.img"
          EMMC_FILES=( "${SYSUP_IMG}" )
          [ -n "${ROOTFS_EXT4_IMG}" ] && EMMC_FILES+=( "${ROOTFS_EXT4_IMG}" )
          mk_fat32_img "${EMMC_IMG}" 512 "${EMMC_FILES[@]}"

          xz -T0 -f -z "${USB_IMG}"
          xz -T0 -f -z "${EMMC_IMG}"

          mkdir -p artifact
          mv -f *.img.xz artifact/
          ls -lh artifact

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OneCloud-Packages-${{ github.run_number }}
          path: artifact
          retention-days: 7

      - name: Release (manual trigger only)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: onecloud-${{ github.run_number }}
          name: OneCloud ImmortalWrt r${{ github.run_number }}
          body: |
            - onecloud-usb-installer-*.img.xz：U 盘版刷机容器（非可引导整盘）
            - onecloud-direct-flash-*.img.xz：直接线刷容器（非可引导整盘）
            - 说明：请阅读各包内 README.txt
          files: |
            artifact/*.img.xz
