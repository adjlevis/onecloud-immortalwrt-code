name: Build OneCloud ImmortalWrt

on:
  schedule:
    - cron: '0 16 1 * *'  # æ¯æœˆ 1 å·åŒ—äº¬æ—¶é—´ 00:00 è‡ªåŠ¨æ„å»º
  workflow_dispatch:
    inputs:
      kernel_version:
        description: 'é€‰æ‹©å†…æ ¸ç‰ˆæœ¬'
        required: true
        default: '6.6'
        type: choice
        options:
          - '6.6'
          - '6.7'
          - '6.9'

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker image prune --all --force
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
          bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
          git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev \
          libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp p7zip p7zip-full patch pkgconf python3 python3-pip \
          python3-ply python3-setuptools rsync squashfs-tools swig texinfo \
          upx-ucl unzip vim wget xxd zlib1g-dev
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"

      - name: æ¸…ç†ç£ç›˜ç©ºé—´
        run: |
          echo "æ¸…ç†å‰ç£ç›˜ç©ºé—´ï¼š"
          df -h
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d /usr/local/lib/android
          sudo rm -rf /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          echo "æ¸…ç†åç£ç›˜ç©ºé—´ï¼š"
          df -h

      - name: å…‹éš†æºä»£ç 
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
          cd openwrt
          echo "src-git packages https://github.com/immortalwrt/packages.git;openwrt-24.10" >> feeds.conf.default
          echo "src-git luci https://github.com/immortalwrt/luci.git;openwrt-24.10" >> feeds.conf.default
          echo "src-git routing https://github.com/openwrt/routing.git;openwrt-24.10" >> feeds.conf.default
          echo "src-git telephony https://github.com/openwrt/telephony.git;openwrt-24.10" >> feeds.conf.default

      - name: æ›´æ–° & å®‰è£… feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: åº”ç”¨è‡ªå®šä¹‰é…ç½®
        run: |
          if [ -f "diy.sh" ]; then
            chmod +x diy.sh
            cd openwrt
            ../diy.sh
          else
            echo "âš ï¸ diy.sh æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡è‡ªå®šä¹‰é…ç½®"
          fi

      - name: åŠ è½½è‡ªå®šä¹‰ .config é…ç½®
        run: |
          if [ -f ".config" ]; then
            cp .config openwrt/.config
            echo "âœ… å·²åŠ è½½è‡ªå®šä¹‰ .config æ–‡ä»¶"
          else
            echo "âš ï¸ .config æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
            cd openwrt
            make defconfig
          fi

      - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–
        run: |
          cd openwrt
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 V=s
          echo "ç¼–è¯‘å®Œæˆï¼Œå›ºä»¶ä½ç½®ï¼š"
          ls -lh bin/targets/*/*/

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -h

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        id: organize
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          
          # ç”Ÿæˆçº¿åˆ·åŒ…æ–‡ä»¶å
          DEVICE_NAME="OneCloud"
          FIRMWARE_DATE="$(date +%Y%m%d)"
          KERNEL_VER="${{ github.event.inputs.kernel_version || '6.6' }}"
          
          # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
          IMG_FILE=$(ls *.img.gz 2>/dev/null | head -n 1)
          if [ -n "$IMG_FILE" ]; then
            # é‡å‘½åä¸ºçº¿åˆ·ç‰ˆ
            NEW_NAME="${DEVICE_NAME}_ImmortalWrt_${FIRMWARE_DATE}_Kernel${KERNEL_VER}_Flash.img.gz"
            cp "$IMG_FILE" "$NEW_NAME"
            echo "âœ… çº¿åˆ·å›ºä»¶å·²ç”Ÿæˆ: $NEW_NAME"
            echo "FLASH_FIRMWARE=$NEW_NAME" >> $GITHUB_ENV
          fi
          
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          echo "BUILD_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "KERNEL_VERSION=${{ github.event.inputs.kernel_version || '6.6' }}" >> $GITHUB_ENV
          
          echo "========================================="
          echo "å›ºä»¶åˆ—è¡¨ï¼š"
          ls -lh *.img.gz *.manifest 2>/dev/null || echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
          echo "========================================="

      - name: ä¸Šä¼ å›ºä»¶åˆ° Actions Artifacts
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: ImmortalWrt_OneCloud_${{ env.BUILD_DATE }}
          path: ${{ env.FIRMWARE }}
          retention-days: 30

      - name: ç”Ÿæˆ Release æ ‡ç­¾
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "release_tag=ImmortalWrt-OneCloud-$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
          touch release.txt
          echo "## ğŸ”¥ OneCloud çº¿åˆ·å›ºä»¶ (ImmortalWrt)" >> release.txt
          echo "" >> release.txt
          echo "### ğŸ“… æ„å»ºä¿¡æ¯" >> release.txt
          echo "- ğŸ•’ æ„å»ºæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> release.txt
          echo "- ğŸ§ å†…æ ¸ç‰ˆæœ¬: Linux ${{ env.KERNEL_VERSION }}" >> release.txt
          echo "- ğŸ“¦ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}" >> release.txt
          echo "- ğŸ’¾ å›ºä»¶ç±»å‹: **çº¿åˆ·ç‰ˆï¼ˆeMMC ç›´åˆ·ï¼‰**" >> release.txt
          echo "" >> release.txt
          echo "### ğŸ’» è®¾å¤‡è§„æ ¼" >> release.txt
          echo "- å‹å·: è¿…é›·ç©å®¢äº‘ (OneCloud)" >> release.txt
          echo "- CPU: Amlogic S805 (Cortex-A5 å››æ ¸)" >> release.txt
          echo "- å†…å­˜: 1GB DDR3" >> release.txt
          echo "- å­˜å‚¨: 8GB eMMC" >> release.txt
          echo "- ç½‘å£: åƒå…†ä»¥å¤ªç½‘ (1000M)" >> release.txt
          echo "- USB: 4x USB 2.0" >> release.txt
          echo "" >> release.txt
          echo "### ğŸŒ é»˜è®¤é…ç½®" >> release.txt
          echo "- IP åœ°å€: \`192.168.2.2\`" >> release.txt
          echo "- ç½‘å…³: \`192.168.2.1\`" >> release.txt
          echo "- ç”¨æˆ·å: \`root\`" >> release.txt
          echo "- å¯†ç : **æ— **ï¼ˆé¦–æ¬¡ç™»å½•ç›´æ¥å›è½¦ï¼‰" >> release.txt
          echo "" >> release.txt
          echo "### ğŸ“¥ çº¿åˆ·æ•™ç¨‹" >> release.txt
          echo "" >> release.txt
          echo "#### æ–¹æ³•ä¸€ï¼šUç›˜å¯åŠ¨åˆ·æœºï¼ˆæ¨èï¼‰" >> release.txt
          echo "1. ä¸‹è½½ä¸‹æ–¹çš„ \`*_Flash.img.gz\` å›ºä»¶æ–‡ä»¶" >> release.txt
          echo "2. è§£å‹å¾—åˆ° \`.img\` æ–‡ä»¶" >> release.txt
          echo "3. ä½¿ç”¨ [balenaEtcher](https://etcher.balena.io/) æˆ– Rufus å°†é•œåƒå†™å…¥ Uç›˜" >> release.txt
          echo "4. OneCloud æ–­ç”µï¼Œæ’å…¥ Uç›˜" >> release.txt
          echo "5. **æŒ‰ä½å¤ä½é”®ä¸æ”¾**ï¼Œç»™è®¾å¤‡é€šç”µ" >> release.txt
          echo "6. ç­‰å¾… LED ç¯é—ªçƒåæ¾å¼€å¤ä½é”®" >> release.txt
          echo "7. ç³»ç»Ÿä¼šè‡ªåŠ¨ä» Uç›˜å¯åŠ¨å¹¶å®‰è£…åˆ° eMMCï¼ˆçº¦ 3-5 åˆ†é’Ÿï¼‰" >> release.txt
          echo "8. å®‰è£…å®Œæˆåæ‹”æ‰ Uç›˜ï¼Œé‡å¯è®¾å¤‡" >> release.txt
          echo "" >> release.txt
          echo "#### æ–¹æ³•äºŒï¼šçº¿åˆ·å·¥å…·åˆ·æœº" >> release.txt
          echo "1. ä¸‹è½½ [USB Burning Tool](https://www.amlsetup.com/usb-burning-tool/)" >> release.txt
          echo "2. OneCloud è¿›å…¥çº¿åˆ·æ¨¡å¼ï¼ˆçŸ­æ¥ä¸»æ¿è§¦ç‚¹ï¼‰" >> release.txt
          echo "3. ä½¿ç”¨å·¥å…·åˆ·å…¥ \`.img\` æ–‡ä»¶" >> release.txt
          echo "" >> release.txt
          echo "### ğŸ“ æ–‡ä»¶è¯´æ˜" >> release.txt
          echo "- \`**_Flash.img.gz\`: **çº¿åˆ·å›ºä»¶**ï¼ˆä¸‹è½½æ­¤æ–‡ä»¶ï¼‰" >> release.txt
          echo "- \`*.manifest\`: è½¯ä»¶åŒ…åˆ—è¡¨ï¼ˆå¯é€‰æŸ¥çœ‹ï¼‰" >> release.txt
          echo "" >> release.txt
          echo "### âœ¨ ä¸»è¦åŠŸèƒ½" >> release.txt
          echo "- âœ… USB å­˜å‚¨è®¾å¤‡æ”¯æŒï¼ˆå¯æ¥ç§»åŠ¨ç¡¬ç›˜ï¼‰" >> release.txt
          echo "- âœ… Samba æ–‡ä»¶å…±äº«" >> release.txt
          echo "- âœ… DDNS åŠ¨æ€åŸŸå" >> release.txt
          echo "- âœ… UPnP ç«¯å£æ˜ å°„" >> release.txt
          echo "- âœ… ZeroTier è™šæ‹Ÿå±€åŸŸç½‘" >> release.txt
          echo "- âœ… ç½‘ç»œåŠ é€Ÿï¼ˆTurbo ACCï¼‰" >> release.txt
          echo "- âœ… æµé‡ç›‘æ§ã€å®šæ—¶é‡å¯" >> release.txt
          echo "- âœ… KMS æ¿€æ´»æœåŠ¡å™¨" >> release.txt
          echo "- âœ… å®Œæ•´ IPv6 æ”¯æŒ" >> release.txt
          echo "" >> release.txt
          echo "### âš ï¸ æ³¨æ„äº‹é¡¹" >> release.txt
          echo "1. åˆ·æœºä¼š**æ¸…ç©º eMMC æ•°æ®**ï¼Œè¯·æå‰å¤‡ä»½é‡è¦æ–‡ä»¶" >> release.txt
          echo "2. åˆ·æœºè¿‡ç¨‹ä¸­**ä¸è¦æ–­ç”µ**" >> release.txt
          echo "3. é¦–æ¬¡å¯åŠ¨éœ€è¦ 2-3 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…" >> release.txt
          echo "4. åˆ·æœºåé»˜è®¤ IP ä¸º \`192.168.2.2\`ï¼Œè¯·ç¡®ä¿ç”µè„‘åœ¨åŒä¸€ç½‘æ®µ" >> release.txt
          echo "" >> release.txt
          echo "### ğŸ†˜ å¸¸è§é—®é¢˜" >> release.txt
          echo "- **Q: åˆ·æœºåæ— æ³•å¯åŠ¨ï¼Ÿ**" >> release.txt
          echo "  - A: æ£€æŸ¥æ˜¯å¦å®Œå…¨å†™å…¥ï¼Œé‡æ–°åˆ·å†™ä¸€æ¬¡" >> release.txt
          echo "- **Q: æ— æ³•è®¿é—® 192.168.2.2ï¼Ÿ**" >> release.txt
          echo "  - A: ç¡®ä¿ç”µè„‘ IP åœ¨ 192.168.2.x ç½‘æ®µï¼Œæˆ–è¿æ¥è·¯ç”±å™¨ DHCP" >> release.txt
          echo "- **Q: å¿˜è®°ä¿®æ”¹çš„å¯†ç ï¼Ÿ**" >> release.txt
          echo "  - A: é‡æ–°åˆ·æœºæˆ–è¿›å…¥ Failsafe æ¨¡å¼é‡ç½®" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: åˆ é™¤æ—§çš„ Release
        uses: dev-drprasad/delete-older-releases@v0.3.4
        if: steps.tag.outputs.status == 'success' && !cancelled()
        with:
          keep_latest: 1
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒåˆ° GitHub Releases
        uses: softprops/action-gh-release@v2
        if: steps.tag.outputs.status == 'success' && !cancelled()
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: OneCloud ImmortalWrt ${{ env.BUILD_DATE }}
          body_path: release.txt
          files: ${{ env.FIRMWARE }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ¸…ç†æ—§çš„ Workflow è¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        if: (!cancelled())
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 3
