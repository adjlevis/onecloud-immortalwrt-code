name: Build OneCloud ImmortalWrt (EXT4 EMMC_BURN)

on:
  workflow_dispatch: {}
  # 自动定时构建（北京时间每日 00:00）
  # schedule:
  #   - cron: "0 16 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      TZ: Asia/Shanghai
      OPENWRT_DIR: openwrt

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gawk flex bison libssl-dev libncurses5-dev zlib1g-dev \
            git gettext unzip wget curl rsync swig file device-tree-compiler \
            python3 subversion qemu-utils upx-ucl xz-utils zstd \
            parted dosfstools e2fsprogs gzip

      - name: Clone ImmortalWrt 24.10
        run: |
          git clone --depth=1 -b openwrt-24.10 https://github.com/immortalwrt/immortalwrt.git "$OPENWRT_DIR"

      - name: Apply custom config & diy.sh
        run: |
          if [ -f ".config" ]; then cp -f .config "$OPENWRT_DIR/.config"; fi
          if [ -f "diy.sh" ]; then cp -f diy.sh "$OPENWRT_DIR/diy.sh" && chmod +x "$OPENWRT_DIR/diy.sh"; fi
          cd "$OPENWRT_DIR"
          [ -x ./diy.sh ] && ./diy.sh || true

      - name: Update & install feeds
        run: |
          cd "$OPENWRT_DIR"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure
        run: |
          cd "$OPENWRT_DIR"
          make defconfig

      - name: Build firmware
        run: |
          cd "$OPENWRT_DIR"
          make -j"$(nproc)" || make -j1 V=s

      - name: Make EMMC_BURN image
        run: |
          set -eux
          TARGET_DIR="$(ls -d ${OPENWRT_DIR}/bin/targets/*/*)"
          echo "TARGET_DIR=${TARGET_DIR}"

          SYSUP_IMG="$(ls ${TARGET_DIR}/*-ext4-sysupgrade.img.gz 2>/dev/null | head -n1 || true)"
          ROOTFS_IMG="$(ls ${TARGET_DIR}/*-rootfs-ext4.img* 2>/dev/null | head -n1 || true)"

          if [ -z "${SYSUP_IMG}" ]; then
            echo "❌ 未找到 *-ext4-sysupgrade.img.gz"
            exit 1
          fi

          echo "使用镜像：${SYSUP_IMG}"
          mkdir -p "${TARGET_DIR}/release"

          # 解压 sysupgrade 镜像
          gunzip -c "${SYSUP_IMG}" > rootfs.img

          # 创建 eMMC 线刷镜像（含 boot/root 分区结构）
          IMG_NAME="onecloud-immortalwrt-EXT4-EMMC_BURN.img"
          dd if=/dev/zero of="${IMG_NAME}" bs=1M count=2048 status=progress
          parted "${IMG_NAME}" --script mklabel gpt
          parted "${IMG_NAME}" --script mkpart boot ext4 1MiB 64MiB
          parted "${IMG_NAME}" --script mkpart root ext4 64MiB 100%

          # 格式化分区
          LOOP=$(sudo losetup -f --show "${IMG_NAME}")
          sudo partprobe "${LOOP}"
          BOOT_LOOP="${LOOP}p1"
          ROOT_LOOP="${LOOP}p2"
          sudo mkfs.ext4 -L boot "${BOOT_LOOP}"
          sudo mkfs.ext4 -L rootfs "${ROOT_LOOP}"

          # 写入 rootfs
          sudo dd if=rootfs.img of="${ROOT_LOOP}" bs=1M conv=fsync
          sync
          sudo losetup -d "${LOOP}"

          gzip -c "${IMG_NAME}" > "${TARGET_DIR}/release/${IMG_NAME}.gz"
          ls -lh "${TARGET_DIR}/release"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: "burn-${{ github.run_id }}"
          name: "OneCloud ImmortalWrt EXT4-EMMC_BURN"
          body: |
            自动构建的 OneCloud 线刷包  
            - 格式：EXT4-EMMC_BURN.img.gz  
            - 可直接写入 eMMC（适配自刷 U-Boot）  
            - 构建时间：${{ github.run_started_at }}
          files: |
            ${{ env.OPENWRT_DIR }}/bin/targets/*/*/release/*.img.gz

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
